<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - OncoCare Radiotherapy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style_v2.css">
</head>
<body>

    <header class="navbar">
        <div class="brand-logo">
            <i class="fa-solid fa-radiation logo-icon"></i>
            <span>OncoCare Radiotherapy Center</span>
        </div>
        <div class="date-display" id="current-date">
            </div>
    </header>

    <div class="main-content-wrapper">

        <aside class="sidebar">
            <div class="calendar-widget card-container">
                <div class="calendar-header">
                    <i class="fa-solid fa-chevron-left"></i>
                    <span>November 2024</span>
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
                <div class="calendar-weekdays"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
                <div class="calendar-days">
                    <div class="prev-month">27</div><div class="prev-month">28</div><div class="prev-month">29</div><div class="prev-month">30</div><div class="prev-month">31</div>
                    <div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div>
                    <div class="today">25</div>
                    <div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div class="next-month">1</div>
                </div>
            </div>
        </aside>

        <section class="schedule-content">
            
            <div class="dept-tabs">
                <button class="tab-btn active"><i class="fa-solid fa-x-ray"></i> LINAC Treatment</button>
                <button class="tab-btn"><i class="fa-solid fa-procedures"></i> Simulation (CT/MR)</button>
                <button class="tab-btn"><i class="fa-solid fa-user-doctor"></i> Consults</button>
                <button class="tab-btn"><i class="fa-solid fa-wand-magic-sparkles"></i> HDR/Special</button>
            </div>

            <div class="linac-rooms-grid">
                <div class="room-column">
                    <h2 class="room-title"><i class="fa-solid fa-circle-play text-success"></i> LINAC 1 (TrueBeam A)</h2>
                    <div class="schedule-list-container"><ul class="schedule-list" id="linac1-list" data-room-id="linac1"></ul></div>
                </div>
                <div class="room-column">
                    <h2 class="room-title"><i class="fa-solid fa-circle-play text-success"></i> LINAC 2 (TrueBeam B)</h2>
                    <div class="schedule-list-container"><ul class="schedule-list" id="linac2-list" data-room-id="linac2"></ul></div>
                </div>
                <div class="room-column">
                    <h2 class="room-title"><i class="fa-solid fa-circle-stop text-muted"></i> LINAC 3 (Halcyon)</h2>
                    <div class="schedule-list-container"><ul class="schedule-list" id="linac3-list" data-room-id="linac3"></ul></div>
                </div>
            </div> 
        </section>
    </div>

    <script>
        // ============================================
        // 1. MASTER DATA STRUCTURE
        // ============================================
        let scheduleData = [
            // --- LINAC 1 Data ---
            { id: 'l1-1', roomId: 'linac1', type: 'appt', time: '08:00 - 08:30', ptName: 'Alice Brown', ptDetails: 'Rt Proximal Femur (3D-CRT)', status: 'Scheduled', chartLink: 'Alice_Brown_SkeletalExtremity.json' },
            { id: 'l1-2', roomId: 'linac1', type: 'appt', time: '08:30 - 08:45', ptName: 'Linda Jones', ptDetails: 'Thorax IMRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-3', roomId: 'linac1', type: 'appt', time: '08:45 - 09:15', ptName: 'Michael Chen', ptDetails: 'Head & Neck VMAT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-g1', roomId: 'linac1', type: 'gap', text: '09:15 - 09:30 | Morning QA Check' },
            { id: 'l1-4', roomId: 'linac1', type: 'appt', time: '09:30 - 10:00', ptName: 'Sarah Davis', ptDetails: 'Breast 3D-CRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-5', roomId: 'linac1', type: 'appt', time: '10:00 - 10:30', ptName: 'William Thompson', ptDetails: 'Rectum VMAT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-6', roomId: 'linac1', type: 'appt', time: '10:30 - 11:15', ptName: 'Emily Wilson', ptDetails: 'Cervix VMAT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-g2', roomId: 'linac1', type: 'gap', text: '11:15 - 12:30 | Lunch Break / Physics QA' },
            { id: 'l1-7', roomId: 'linac1', type: 'appt', time: '12:30 - 13:00', ptName: 'David Anderson', ptDetails: 'Esophagus IMRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-8', roomId: 'linac1', type: 'appt', time: '13:00 - 13:30', ptName: 'Amanda Thomas', ptDetails: 'Sarcoma IMRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-9', roomId: 'linac1', type: 'appt', time: '13:30 - 14:00', ptName: 'Patrick Moore', ptDetails: 'Bladder VMAT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-10', roomId: 'linac1', type: 'appt', time: '14:00 - 14:45', ptName: 'Jennifer Jackson', ptDetails: 'Spine SBRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-g3', roomId: 'linac1', type: 'gap', text: '14:45 - 15:15 | Machine Break' },
            { id: 'l1-11', roomId: 'linac1', type: 'appt', time: '15:15 - 15:45', ptName: 'Brian Martin', ptDetails: 'Lymphoma IS', status: 'Scheduled', chartLink: '#' },
            { id: 'l1-12', roomId: 'linac1', type: 'appt', time: '15:45 - 16:30', ptName: 'Elizabeth Lee', ptDetails: 'Whole Brain (Hippocampal Avoidance)', status: 'Scheduled', chartLink: '#' },

            // --- LINAC 2 Data ---
            { id: 'l2-1', roomId: 'linac2', type: 'appt', time: '08:00 - 09:00', ptName: 'Robert Miller', ptDetails: 'Lung SBRT (RUL)', status: 'Scheduled', chartLink: 'Robert_Miller_ThoraxSBRT.json' },
            { id: 'l2-g1', roomId: 'linac2', type: 'gap', text: '09:00 - 09:30 | Room Cleaning / Setup' },
            { id: 'l2-2', roomId: 'linac2', type: 'appt', time: '09:30 - 10:30', ptName: 'Jessica Martinez', ptDetails: 'Brain SRS (Multiple Mets)', status: 'Scheduled', chartLink: '#' },
            { id: 'l2-3', roomId: 'linac2', type: 'appt', time: '10:30 - 11:30', ptName: 'Christopher Taylor', ptDetails: 'Pancreas SBRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l2-g2', roomId: 'linac2', type: 'gap', text: '11:30 - 13:00 | Lunch Break / Physics Support' },
            { id: 'l2-4', roomId: 'linac2', type: 'appt', time: '13:00 - 14:00', ptName: 'Daniel Hernandez', ptDetails: 'Prostate SBRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l2-5', roomId: 'linac2', type: 'appt', time: '14:00 - 15:15', ptName: 'Melissa White', ptDetails: 'Liver SBRT (Breath Hold)', status: 'Scheduled', chartLink: '#' },
            { id: 'l2-g3', roomId: 'linac2', type: 'gap', text: '15:15 - 17:00 | Physics QA / Service' },

            // --- LINAC 3 Data ---
            { id: 'l3-g1', roomId: 'linac3', type: 'gap', text: '08:00 - 08:30 | Morning Warmup' },
            { id: 'l3-1', roomId: 'linac3', type: 'appt', time: '08:30 - 09:00', ptName: 'Jane Smith', ptDetails: 'Urgent SVCS (AP/PA)', status: 'Scheduled', chartLink: 'Jane_Smith_SVCS.json' },
            { id: 'l3-2', roomId: 'linac3', type: 'appt', time: '09:00 - 09:30', ptName: 'James Wilson', ptDetails: 'Prostate VMAT', status: 'Scheduled', chartLink: 'James_Wilson_PelvisProstate.json' },
            { id: 'l3-3', roomId: 'linac3', type: 'appt', time: '09:30 - 10:00', ptName: 'George Harris', ptDetails: 'L3 Spine (Palliative)', status: 'Scheduled', chartLink: 'George_Harris_SkeletalSpine.json' },
            { id: 'l3-4', roomId: 'linac3', type: 'appt', time: '10:00 - 10:30', ptName: 'Barbara Garcia', ptDetails: 'Whole Breast (Tangents)', status: 'Scheduled', chartLink: '#' },
            { id: 'l3-g2', roomId: 'linac3', type: 'gap', text: '10:30 - 12:00 | Mid-day Break / Therapist Meeting' },
            { id: 'l3-5', roomId: 'linac3', type: 'appt', time: '12:00 - 12:30', ptName: 'Richard Davis', ptDetails: 'Prostate Bed VMAT', status: 'Scheduled', chartLink: '#' },
            { id: 'l3-6', roomId: 'linac3', type: 'appt', time: '12:30 - 13:00', ptName: 'Susan Clark', ptDetails: 'Chest Wall + Nodes', status: 'Scheduled', chartLink: '#' },
            { id: 'l3-7', roomId: 'linac3', type: 'appt', time: '13:00 - 13:30', ptName: 'Joseph Hall', ptDetails: 'Lung IMRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l3-g3', roomId: 'linac3', type: 'gap', text: '13:30 - 14:30 | Machine Break' },
            { id: 'l3-8', roomId: 'linac3', type: 'appt', time: '14:30 - 15:00', ptName: 'Margaret Allen', ptDetails: 'Rectum 3D-CRT', status: 'Scheduled', chartLink: '#' },
            { id: 'l3-g4', roomId: 'linac3', type: 'gap', text: '15:00 - 17:00 | End of Day QA' },
        ];


        // ============================================
        // 2. RENDERING ENGINE (Generates HTML from Data)
        // ============================================
        function renderSchedule() {
            // Clear current lists
            ['linac1', 'linac2', 'linac3'].forEach(roomId => {
                document.getElementById(`${roomId}-list`).innerHTML = '';
            });

            // Sort data by time to ensure correct order display
            scheduleData.sort((a, b) => a.time.localeCompare(b.time));

            // Loop through data and generate HTML
            scheduleData.forEach(item => {
                const listContainer = document.getElementById(`${item.roomId}-list`);
                let html = '';

                if (item.type === 'gap') {
                    // Gap rows are not draggable and have no drop zone
                    html = `<li class="schedule-time-row gap-row">${item.text}</li>`;
                } 
                else if (item.type === 'appt') {
                    const isReady = item.status === 'Ready';
                    const statusClass = isReady ? 'status-ready' : '';
                    const readyBtnClass = isReady ? 'hidden' : '';
                    const openBtnClass = isReady ? '' : 'hidden';
                    const linkHref = item.chartLink && item.chartLink !== '#' ? `patient_v2.html?file=${item.chartLink}` : '#';

                    // New Structure: Row -> Fixed Time Label + Drop Zone -> Draggable Patient Card
                    html = `
                        <li class="schedule-time-row ${statusClass}" data-time="${item.time}">
                            <div class="fixed-time-label">${item.time}</div>
                            
                            <div class="patient-drop-zone">
                                <div class="draggable-patient-card" draggable="true" data-patient-id="${item.id}">
                                    <div class="patient-info">
                                        <h3>${item.ptName}</h3>
                                        <div class="patient-details"><span>${item.ptDetails}</span></div>
                                    </div>
                                    <div class="card-actions">
                                        <span class="status-badge">${item.status}</span>
                                        <button class="btn-action btn-mark-ready ${readyBtnClass}" title="Mark Ready"><i class="fa-solid fa-check"></i></button>
                                        <a href="${linkHref}" class="btn-action btn-open-chart ${openBtnClass}" title="Open Chart"><i class="fa-solid fa-arrow-right-to-bracket"></i></a>
                                    </div>
                                </div>
                            </div>
                        </li>
                    `;
                }
                listContainer.insertAdjacentHTML('beforeend', html);
            });

            // Re-initialize listeners after rendering
            initializeEventHandlers();
        }


        // ============================================
        // 3. EVENT HANDLERS (Drag & Drop + Clicks)
        // ============================================
        function initializeEventHandlers() {
            
            // --- A. Mark Ready Click Handler ---
            document.querySelectorAll('.btn-mark-ready').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const patientCard = e.target.closest('.draggable-patient-card');
                    const patientId = patientCard.getAttribute('data-patient-id');
                    // Update Data
                    const dataItem = scheduleData.find(item => item.id === patientId);
                    if (dataItem) { dataItem.status = 'Ready'; }
                    // Re-render
                    renderSchedule();
                });
            });


            // --- B. Drag and Drop Handlers ---
            const draggables = document.querySelectorAll('.draggable-patient-card');
            const dropZones = document.querySelectorAll('.patient-drop-zone');

            // 1. Drag Start/End on Patient Cards
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', (e) => {
                    draggable.classList.add('dragging');
                    // Store the patient ID being dragged
                    e.dataTransfer.setData('text/plain', draggable.getAttribute('data-patient-id'));
                });
                draggable.addEventListener('dragend', () => {
                    draggable.classList.remove('dragging');
                     // Clean up any leftover hover effects
                    dropZones.forEach(dz => dz.classList.remove('drag-over'));
                });
            });

            // 2. Drag Over/Leave on Drop Zones
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault(); // Allow dropping
                    // Only show hover effect if zone is empty
                    if (zone.children.length === 0) {
                         zone.classList.add('drag-over');
                    }
                });
                zone.addEventListener('dragleave', e => {
                     zone.classList.remove('drag-over');
                });

                // 3. Drop Action
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    // Ensure drop zone is empty before accepting
                    if (zone.children.length > 0) return;

                    const patientId = e.dataTransfer.getData('text/plain');
                    
                    // Find the new context based on where it was dropped
                    const newTimeRow = zone.closest('.schedule-time-row');
                    const newTimeStr = newTimeRow.getAttribute('data-time');
                    const newRoomList = zone.closest('.schedule-list');
                    const newRoomId = newRoomList.getAttribute('data-room-id');

                    // Update Master Data Structure
                    const patientData = scheduleData.find(item => item.id === patientId);
                    if (patientData) {
                        patientData.time = newTimeStr;
                        patientData.roomId = newRoomId;
                        // Re-render updated schedule
                        renderSchedule();
                    }
                });
            });
        }


        // ============================================
        // 4. INITIAL LOAD
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Set date
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').innerHTML = '<i class="fa-regular fa-calendar-days"></i> ' + new Date().toLocaleDateString('en-US', options);

            // Initial Render
            renderSchedule();
        });
    </script>
</body>
</html>
