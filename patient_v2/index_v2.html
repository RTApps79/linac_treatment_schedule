<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule - OncoCare Radiotherapy</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style_v2 (1).css"> 
</head>
<body class="schedule-layout">

    <header class="navbar">
        <div class="brand-logo">
            <i class="fa-solid fa-radiation logo-icon"></i>
            <span>OncoCare Radiotherapy Center</span>
        </div>
        <div class="date-display" id="current-date"></div>
    </header>

    <div class="main-content-wrapper">

        <aside class="sidebar-column">
            <div class="calendar-widget card-container">
                <div class="calendar-header">
                    <i class="fa-solid fa-chevron-left"></i><span>November 2024</span><i class="fa-solid fa-chevron-right"></i>
                </div>
                <div class="calendar-weekdays"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
                <div class="calendar-days">
                     <div class="prev-month">27</div><div class="prev-month">28</div><div class="prev-month">29</div><div class="prev-month">30</div><div class="prev-month">31</div>
                    <div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div>
                    <div class="today">25</div>
                    <div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div class="next-month">1</div>
                </div>
            </div>
        </aside>

        <aside class="sidebar-column" style="background-color: var(--bg-card);">
            <h3 class="sidebar-title">Unscheduled Patients</h3>
            <ul class="staging-list" id="staging-list-container">
                </ul>
        </aside>

        <section class="schedule-content">
            <div class="dept-tabs">
                <button class="tab-btn active"><i class="fa-solid fa-x-ray"></i> LINAC Treatment</button>
                <button class="tab-btn"><i class="fa-solid fa-procedures"></i> Simulation</button>
                <button class="tab-btn"><i class="fa-solid fa-user-doctor"></i> Consults</button>
            </div>

            <div class="linac-rooms-grid">
                <div class="room-column">
                    <h2 class="room-title"><i class="fa-solid fa-circle-play text-success"></i> LINAC 1</h2>
                    <div class="schedule-list-container"><ul class="schedule-list" id="linac1-list" data-room-id="linac1"></ul></div>
                </div>
                <div class="room-column">
                    <h2 class="room-title"><i class="fa-solid fa-circle-play text-success"></i> LINAC 2</h2>
                    <div class="schedule-list-container"><ul class="schedule-list" id="linac2-list" data-room-id="linac2"></ul></div>
                </div>
                <div class="room-column">
                    <h2 class="room-title"><i class="fa-solid fa-circle-stop text-muted"></i> LINAC 3</h2>
                    <div class="schedule-list-container"><ul class="schedule-list" id="linac3-list" data-room-id="linac3"></ul></div>
                </div>
            </div> 
        </section>
    </div>

    <script>
        // ============================================
        // 1. DEFINITIONS & DATA
        // ============================================
        const timeSlots = [
            '08:00 - 08:30', '08:30 - 09:00', '09:00 - 09:30', '09:30 - 10:00',
            '10:00 - 10:30', '10:30 - 11:00', '11:00 - 11:30', '11:30 - 12:00',
            '12:00 - 12:30', '12:30 - 13:00', '13:00 - 13:30', '13:30 - 14:00',
            '14:00 - 14:30', '14:30 - 15:00', '15:00 - 15:30', '15:30 - 16:00',
            '16:00 - 16:30', '16:30 - 17:00'
        ];

        // Master Data: Some scheduled, some unscheduled
        let patientData = [
            // Scheduled Patients
            { id: 'p1', roomId: 'linac1', time: '08:00 - 08:30', ptName: 'Alice Brown', ptDetails: 'Rt Proximal Femur', status: 'Scheduled', chartLink: 'Alice_Brown_SkeletalExtremity.json' },
            { id: 'p2', roomId: 'linac2', time: '09:00 - 09:30', ptName: 'Robert Miller', ptDetails: 'Lung SBRT', status: 'Scheduled', chartLink: 'Robert_Miller_ThoraxSBRT.json' },
            { id: 'p3', roomId: 'linac3', time: '08:30 - 09:00', ptName: 'Jane Smith', ptDetails: 'Urgent SVCS', status: 'Ready', chartLink: 'Jane_Smith_SVCS.json' },
            
            // Unscheduled Patients (Staging Area)
            { id: 'p4', roomId: 'unscheduled', time: null, ptName: 'Michael Chen', ptDetails: 'Head & Neck VMAT', status: 'Pending', chartLink: '#' },
            { id: 'p5', roomId: 'unscheduled', time: null, ptName: 'Sarah Davis', ptDetails: 'Breast 3D-CRT', status: 'Pending', chartLink: '#' },
            { id: 'p6', roomId: 'unscheduled', time: null, ptName: 'William Thompson', ptDetails: 'Rectum VMAT', status: 'Pending', chartLink: '#' },
            { id: 'p7', roomId: 'unscheduled', time: null, ptName: 'Emily Wilson', ptDetails: 'Cervix VMAT', status: 'Pending', chartLink: '#' },
            { id: 'p8', roomId: 'unscheduled', time: null, ptName: 'David Anderson', ptDetails: 'Esophagus IMRT', status: 'Pending', chartLink: '#' },
             { id: 'p9', roomId: 'unscheduled', time: null, ptName: 'James Wilson', ptDetails: 'Prostate VMAT', status: 'Pending', chartLink: 'James_Wilson_PelvisProstate.json' },
            { id: 'p10', roomId: 'unscheduled', time: null, ptName: 'George Harris', ptDetails: 'L3 Spine', status: 'Pending', chartLink: 'George_Harris_SkeletalSpine.json' },
        ];


        // ============================================
        // 2. RENDERING ENGINE
        // ============================================
        function renderSchedule() {
            // A. Render Staging Area
            const stagingContainer = document.getElementById('staging-list-container');
            stagingContainer.innerHTML = '';
            patientData.filter(p => p.roomId === 'unscheduled').forEach(pt => {
                stagingContainer.insertAdjacentHTML('beforeend', generatePatientCardHTML(pt));
            });

            // B. Render Room Schedules
            ['linac1', 'linac2', 'linac3'].forEach(roomId => {
                const roomContainer = document.getElementById(`${roomId}-list`);
                roomContainer.innerHTML = '';

                timeSlots.forEach(slot => {
                    // Find if a patient is assigned to this room and time
                    const assignedPatient = patientData.find(p => p.roomId === roomId && p.time === slot);
                    
                    let slotHTML = '';
                    if (assignedPatient) {
                        // Occupied Slot
                        const isReady = assignedPatient.status === 'Ready';
                        slotHTML = `
                            <li class="schedule-time-row occupied ${isReady ? 'status-ready' : ''}" data-time="${slot}">
                                <div class="fixed-time-label">${slot.split(' - ')[0]}</div>
                                <div class="patient-drop-zone">
                                    ${generatePatientCardHTML(assignedPatient)}
                                </div>
                            </li>`;
                    } else {
                        // Empty Slot (Drop Zone)
                        slotHTML = `
                            <li class="schedule-time-row" data-time="${slot}">
                                <div class="fixed-time-label">${slot.split(' - ')[0]}</div>
                                <div class="patient-drop-zone"></div>
                            </li>`;
                    }
                    roomContainer.insertAdjacentHTML('beforeend', slotHTML);
                });
            });
        }

        // Helper to generate card HTML
        function generatePatientCardHTML(pt) {
            const isReady = pt.status === 'Ready';
            const readyBtnClass = isReady ? 'hidden' : '';
            const openBtnClass = isReady ? '' : 'hidden';
            const linkHref = pt.chartLink && pt.chartLink !== '#' ? `patient_v2.html?file=${pt.chartLink}` : '#';
            
            // Don't show actions in staging area for simplicity in this demo
            const showActions = pt.roomId !== 'unscheduled';

            return `
                <div class="draggable-patient-card" draggable="true" data-patient-id="${pt.id}">
                    <div class="patient-info">
                        <h3>${pt.ptName}</h3>
                        <div class="patient-details"><span>${pt.ptDetails}</span></div>
                    </div>
                    ${showActions ? `
                    <div class="card-actions">
                        <button class="btn-action btn-mark-ready ${readyBtnClass}" title="Mark Ready"><i class="fa-solid fa-check"></i></button>
                        <a href="${linkHref}" class="btn-action btn-open-chart ${openBtnClass}" title="Open Chart"><i class="fa-solid fa-arrow-right-to-bracket"></i></a>
                    </div>` : ''}
                </div>`;
        }


        // ============================================
        // 3. EVENT HANDLERS (Delegation)
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Set date
            document.getElementById('current-date').innerHTML = '<i class="fa-regular fa-calendar-days"></i> ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Initial Render
            renderSchedule();

            // --- Event Delegation Setup ---

            // 1. Mark Ready Click
            document.addEventListener('click', function(e) {
                const markReadyBtn = e.target.closest('.btn-mark-ready');
                if (markReadyBtn) {
                    const patientId = markReadyBtn.closest('.draggable-patient-card').getAttribute('data-patient-id');
                    const pt = patientData.find(p => p.id === patientId);
                    if (pt) { pt.status = 'Ready'; renderSchedule(); }
                }
            });

            // 2. Drag Start
            document.addEventListener('dragstart', function(e) {
                const draggable = e.target.closest('.draggable-patient-card');
                if (draggable) {
                    draggable.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', draggable.getAttribute('data-patient-id'));
                    e.dataTransfer.effectAllowed = 'move';
                }
            });

            // 3. Drag End
            document.addEventListener('dragend', function(e) {
                const draggable = e.target.closest('.draggable-patient-card');
                if (draggable) {
                    draggable.classList.remove('dragging');
                    document.querySelectorAll('.patient-drop-zone, .staging-list').forEach(dz => dz.classList.remove('drag-over'));
                }
            });

            // 4. Drag Over (Drop Zones & Staging List)
            document.addEventListener('dragover', function(e) {
                const dropZone = e.target.closest('.patient-drop-zone');
                const stagingList = e.target.closest('.staging-list');

                // Allow over empty drop zones OR the staging list
                if ((dropZone && dropZone.children.length === 0) || stagingList) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if(dropZone) dropZone.classList.add('drag-over');
                    if(stagingList) stagingList.classList.add('drag-over');
                }
            });

             // 5. Drag Leave
             document.addEventListener('dragleave', function(e) {
                const dropZone = e.target.closest('.patient-drop-zone');
                const stagingList = e.target.closest('.staging-list');
                if (dropZone && !dropZone.contains(e.relatedTarget)) dropZone.classList.remove('drag-over');
                if (stagingList && !stagingList.contains(e.relatedTarget)) stagingList.classList.remove('drag-over');
            });


            // 6. Drop Action (The Data Update)
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                const patientId = e.dataTransfer.getData('text/plain');
                const pt = patientData.find(p => p.id === patientId);
                if (!pt) return;

                const dropZone = e.target.closest('.patient-drop-zone');
                const stagingList = e.target.closest('.staging-list');

                // Case A: Dropped into a Schedule Slot
                if (dropZone && dropZone.children.length === 0) {
                    const timeRow = dropZone.closest('.schedule-time-row');
                    const roomList = dropZone.closest('.schedule-list');
                    
                    pt.time = timeRow.getAttribute('data-time');
                    pt.roomId = roomList.getAttribute('data-room-id');
                    pt.status = 'Scheduled'; // Reset status on move
                } 
                // Case B: Dropped back to Staging Area
                else if (stagingList) {
                    pt.roomId = 'unscheduled';
                    pt.time = null;
                    pt.status = 'Pending';
                }

                // Re-render everything to show new state
                renderSchedule();
            });
        });
    </script>
</body>
</html>
